{% assign current_lang = page.lang %}
{% if current_lang == nil %}
  {% if page.url contains '/en/' %}
    {% assign current_lang = 'en' %}
  {% elsif page.url contains '/hu/' %}
    {% assign current_lang = 'hu' %}
  {% else %}
    {% assign current_lang = site.default_language %}
  {% endif %}
{% endif %}
{% assign translations = site.data.translations %}
{% assign language_label = translations.language_selector[current_lang] | default: "Language" %}
{% assign base_path = page.url | default: '/' %}
{% if base_path == '/index.html' %}
  {% assign base_path = '/' %}
{% endif %}
{% if base_path contains '/en/' %}
  {% assign base_path = base_path | remove_first: '/en' %}
{% elsif base_path contains '/hu/' %}
  {% assign base_path = base_path | remove_first: '/hu' %}
{% elsif base_path == '/en' or base_path == '/hu' %}
  {% assign base_path = '/' %}
{% endif %}
{% if base_path == '' %}
  {% assign base_path = '/' %}
{% endif %}
{% assign switcher_id = 'language-select-' | append: current_lang | append: '-' | append: page.url | slugify %}

<div class="language-switcher">
  <label for="{{ switcher_id }}">{{ language_label }}:</label>
  <select id="{{ switcher_id }}" class="language-select" onchange="if (this.value) window.location.href = this.value;">
    {% for lang in site.languages %}
      {% assign lang_root = '/' | append: lang | append: '/' %}
      {% if base_path == '/' %}
        {% assign candidate_url = lang_root %}
      {% else %}
        {% assign candidate_url = '/' | append: lang | append: base_path %}
      {% endif %}
      {% assign matches = site.pages | where: "url", candidate_url %}
      {% assign target_url = lang_root %}
      {% if matches and matches.size > 0 %}
        {% assign target_url = candidate_url %}
      {% endif %}
      <option value="{{ target_url | relative_url }}" {% if lang == current_lang %}selected{% endif %}>
        {% case lang %}
          {% when 'en' %}
            English
          {% when 'hu' %}
            Magyar
          {% else %}
            {{ lang | upcase }}
        {% endcase %}
      </option>
    {% endfor %}
  </select>
</div>

<style>
.language-switcher {
  display: inline-block;
  margin-left: 1rem;
}

/* When in navigation sidebar */
.nav-language-switcher {
  padding: 1rem;
  margin-top: 2rem;
  border-top: 1px solid var(--color-border, #e1e4e8);
}

.nav-language-switcher .language-switcher {
  display: block;
  margin-left: 0;
}

/* When in header, align properly with search and aux links */
.main-header .language-switcher {
  display: inline-flex;
  align-items: center;
  margin-right: 1rem;
}

.language-switcher label {
  margin-right: 0.5rem;
  font-size: 0.875rem;
  color: var(--color-foreground, #333);
}

.language-switcher select {
  padding: 0.25rem 0.5rem;
  border: 1px solid var(--color-border, #ccc);
  border-radius: 4px;
  background-color: var(--color-background, #fff);
  color: var(--color-foreground, #333);
  font-size: 0.875rem;
  cursor: pointer;
  width: 100%;
  max-width: 200px;
}

/* Dark theme support */
[data-theme="dark"] .language-switcher select,
.dark-mode .language-switcher select {
  background-color: #2f3136;
  color: #e3e5e8;
  border-color: #40444b;
}

[data-theme="dark"] .nav-language-switcher,
.dark-mode .nav-language-switcher {
  border-top-color: #40444b;
}

/* Mobile responsive */
@media (max-width: 768px) {
  .main-header .language-switcher {
    margin-top: 0.5rem;
    margin-bottom: 0.5rem;
  }
}
</style>
